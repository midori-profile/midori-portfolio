---
title: "Uni-Code: Leveraging Monorepo for Enhanced Collaboration and Efficiency"
publishedAt: '2022-12-15'
summary: ''
---

## Introduction

In the software development process, the way codes are organized directly impacts team collaboration efficiency. 
There are two mainstream code management strategies currently: ``Multi-repo`` and `Monorepo`. 
In this article, we will discuss the practice of using a `Monorepo` to organize applications and modules within Tencent Cloud Operating System.


## What is Monorepo?

`Monorepo` is a project management strategy that allows storing multiple projects or modules within a single shared code repository. whille `Multi-repo` means each project or module resides in its own repository.


## Why do we need to use Monorepo in our business?

Before discussing `Monorepo`'s benefits, it's important to understand some `Multi-repo's` shortcomings that `Monorepo` aims to address.

### Shortcomings of Multi-repo:

1. **Code Reuse Sometimes Causes Trouble:**
   In our case, we had similar apps deployed on different platforms, with a lot of repetitive codes. 
   <Image
   alt={`Website`}
   src={`/images/uni-code/uni-3.jpg`}
   width={800}
   height={200}
   />

   An enum definition can repeat 10 times, including many outdated definitions.

   When a common module changed, updating all modules that depend on it became a cumbersome task. 
   Additionally, because code was dispersed across various locations, searching through repositories often added considerable pain to the team.

2. **Complex Publish Management:**

   In a multi-repo environment, changes to each project or module are recorded independently, making it exceptionally difficult to understand the entire system's change history. 
   
   Automation tools struggle to link changes across repositories, thereby affecting the efficiency of version management and release processes.

### Advantages of Using Monorepo:

<ProsCard 
  title="Monorepo" 
  pros={[
    "Simplified Code Reuse: Since all projects reside within the same repository, sharing and reusing code becomes incredibly simple. We can reference packages at the code level, which also makes debugging much more convenient. Configuration files such as .eslintrc and tsconfig also can be reused. Then we don't have to config them over and over again.",
    "Global Changelog: With Monorepo, the change logs of all projects can be managed collectively, simplifying the creation of a global Changelog. This is beneficial for tracking the historical changes of the entire project group, managing releases, and troubleshooting.",
    "Improved Collaboration: Any good engineering practice will be adopted across all teams and codebases with almost zero cost through automated means. Typical examples include static code analysis, automated testing, and CI/CD."
  ]}
/>

## Now, Establishing an Efficient Monorepo for Business

<Callout emoji="ğŸ’¡">
If you want to run the code directly, you can check [this repository](https://github.com/midori-profile/uni-code)
</Callout>


<Image
  alt={`Website`}
  src={`/images/uni-code/uni-2.jpg`}
  width={800}
  height={200}
/>

While Monorepo offers numerous advantages, fully unleashing its potential requires careful implementation. Here were some primary challenges our business faced:

<Image
  alt={`Website`}
  src={`/images/uni-code/uni-5.jpg`}
  width={800}
  height={200}
/>


1. **Dependency Tool Decision:**
   Our previous shared package was using yarn + lerna. Should we stick with it, or shift to pnpm?

2. **Cross-Project Modules Management:**
   When modules are used across front-end and back-end projects, it's vital to design a robust package structure. Creating a shared package that works seamlessly across various environments (e.g., Web, mini-apps, Node.js, Vite, Webpack) and addresses compatibility issues.

3. **CI/CD Process:**
   If each project has it's own changelog and independent pipelines, there will be huge management and maintenance costs. Therefore, standardized Changelog and standard pipeline are needed .

4. **Server-Side Rendering (SSR) Support**

5. **Adopting Mixed-Language Development (TypeScript/Rust):**
   Using multiple programming languages â€‹â€‹(such as TypeScript and Rust) is an effective way to improve performance. How to organize and manage code in these different languages â€‹â€‹in `Monorepo`, ensuring that they work together without introducing additional complexity.

## Letâ€™s talk about the solutions to each problem one by one:

1. **Dependency Tool Decision (Scroll to the right to see the full content):**

<Table
  data={{
    headers: [
      'Feature/Issue',
      'Lerna + Yarn',
      'pnpm',
    ],
    rows: [
      [
        'Learning Curve',
        'High, requires mastering the combination of two tools',  
        'Low, simplified configuration and built-in commands make it quicker to get started'
      ],
      [
        'Release Speed',
        'Slow, even updating a single package requires installing and building dependencies of all packages',  
        'Fast, reduces unnecessary installation and build through shared dependencies'
      ],
      [
        'Dependency Management',
        'Phantom dependencies issue, increasing runtime risks',  
        'Avoids accessing undeclared dependencies through a non-flattened `node_modules` structure'
      ],
      [
        'Dependency Conflict Handling (DoppelgÃ¤nger Issue)',
        'Conflicts exist, `yarn duplicate` repeatedly packages compatible versions',  
        'Effectively avoids conflicts through symlink technology and intelligent dependency resolution'
      ],
      [
        'Support for `Monorepo`',
        'Requires additional configuration and management to adapt to `Monorepo`',  
        'Naturally suitable for `Monorepo`, e.g., referencing a workspace package named `foo` with `foo:workspace`'
      ],
      [
        'Multi-package Version Management and Release',
        'Powerful, designed for managing multiple packages in a `Monorepo`, offering detailed version control and release process',  
        'Requires additional script support'
      ],
      [
        'Community Support and Maturity',
        'Mature ecosystem',  
        'Still relatively new in the community'
      ],
    ],
  }}
/>


#### Conclusion: Choose pnpm

Considering the significant advantages of `pnpm` in terms of dependency management efficiency, resource usage, security, and natural support for `Monorepo`, we have concluded that choosing `pnpm` as our dependency management tool is the superior decision.

2. **Cross-Project Modules Management:**

2.1 **Module System Selection**

JavaScript æ¨¡å—åŒ–ç³»ç»Ÿå…¶å‘å±•è¿‡ç¨‹å¤§è‡´ä¸ºï¼šCommonJS (CJS) â†’ Asynchronous Module Definition (AMD) â†’ Common Module Definition (CMD) â†’ Universal Module Definition (UMD) â†’ ECMAScript Modules (ESM)ã€‚å½“æˆ‘ä»¬åœ¨è®¾è®¡ monorepo çš„æ—¶å€™ï¼Œéœ€è¦é’ˆå¯¹ä¸åŒçš„åº”ç”¨ç±»å‹ä¸ºå®ƒé€‰æ‹©åˆé€‚çš„æ¨¡å—åŒ–ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯è€ƒè™‘åˆ°åº”ç”¨é—´ä»£ç å¯ä»¥äº’ç›¸æ— ç¼å¼•å…¥

ç›®å‰ amd å’Œ cmd è¯­æ³•ç›¸å¯¹å¤æ‚ä¸”æ„å»ºå·¥å…·æ”¯æŒä¸è¶³ï¼Œå·²ç»ä¸æ˜¯ä¸»æµçš„æ¨¡å—ç³»ç»Ÿäº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦å¯¹æ¯”å…¶ä»–çš„æ¨¡å—æ‰“åŒ…æ–¹å¼

<Table
  data={{
    headers: [
      'Feature',
      'ESM (ES Modules)',
      'CJS (CommonJS)',
    ],
    rows: [
      [
        'Standardization',
        'JavaScript official standardized module system',
        'CommonJS, currently the most used module system in Node.js'
      ],
      [
        'Usage',
        'â€¢ Browser<br>â€¢ Node.js â‰¥ 12.17',
        'â€¢ Node.js<br>â€¢ Front-end projects (with build tools like Webpack or Rollup)'
      ],
      [
        'Tree Shaking',
        'Facilitates tree shaking',
        'Not friendly for tree shaking'
      ],
    ],
  }}
/>

åœ¨äº†è§£è¿™äº›æ¨¡å—ç±»å‹åï¼Œç°é˜¶æ®µé€‰æ‹©æ¨¡å—è§„èŒƒçš„æœ€ä½³å®è·µå¦‚ä¸‹ï¼š

å…±äº«é…ç½®æ¨¡å—ï¼ˆè·¨å‰åç«¯ï¼‰ï¼šåŒæ—¶å‘å¸ƒ ESM å’Œ CJS æ ¼å¼çš„åŒ…ã€‚è™½ç„¶ ESM æ˜¯ç°ä»£åŒ–çš„é€‰æ‹©ï¼Œä½†ç”±äº Node.js å¯¹ ESM çš„æ”¯æŒä»åœ¨å®Œå–„ä¸­ï¼ŒCJS ä¾ç„¶æ˜¯åå¤‡é€‰é¡¹ã€‚

UI ç»„ä»¶åº“ï¼šåŒæ—¶å‘å¸ƒ ESM å’Œ CJS æ ¼å¼çš„åŒ…ã€‚è¿™æ ·åšå¯ä»¥ç¡®ä¿åœ¨å„ç§å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨è¿™äº›ç»„ä»¶åº“ï¼Œæ— è®ºæ˜¯å‰ç«¯æ¡†æ¶å¦‚ React æˆ– Vueï¼Œè¿˜æ˜¯ä½¿ç”¨ Webpack æˆ– Rollup æ‰“åŒ…å·¥å…·ã€‚

é¢å‘ Node.js é¡¹ç›®ï¼šç›®å‰åªéœ€è¦å‘å¸ƒ CJS æ ¼å¼çš„åŒ…ã€‚CJS æ˜¯ Node.js é»˜è®¤çš„æ¨¡å—ç³»ç»Ÿï¼Œæä¾›äº†ç¨³å®šä¸”å¹¿æ³›çš„æ”¯æŒï¼Œé€‚åˆå¤§å¤šæ•°åç«¯é¡¹ç›®éœ€æ±‚ã€‚

æ­¤å¤–ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿˜éœ€è¦è€ƒè™‘ï¼š
å…¼å®¹æ€§ï¼šç¡®ä¿æ¨¡å—èƒ½å¤Ÿåœ¨ç›®æ ‡è¿è¡Œç¯å¢ƒä¸­æ— ç¼è¿è¡Œã€‚å¯¹äºéœ€è¦æ”¯æŒæ—§ç‰ˆæµè§ˆå™¨æˆ– Node.js ç‰ˆæœ¬çš„é¡¹ç›®ï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„è½¬ç æ­¥éª¤ï¼ˆå¦‚ä½¿ç”¨ Babelï¼‰ã€‚

2.2 **Package Structure Design**

æˆ‘ä»¬è¦è®¾è®¡çš„monorepo éœ€è¦æ”¯æŒ çº¯åç«¯é¡¹ç›®ï¼Œå‰ç«¯ç»„ä»¶åº“ï¼Œå‰ç«¯é¡¹ç›®ï¼Œè·¨å‰åç«¯åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ºå®ƒè®¾è®¡çš„ç›®å½•ç»“æ„ç±»ä¼¼ä¸‹é¢

è¿™é‡Œå»ºç«‹è„šæ‰‹æ¶ï¼šåŸºäº**å‘½ä»¤è¡Œ + inquirer + chalk**çš„è„šæ‰‹æ¶å·¥ç¨‹ï¼Œç›¸å…³å‘½ä»¤å·²ç»å†™å…¥å¤§ä»“è‡ªå®šä¹‰å‘½ä»¤é›†ï¼Œæ‰§è¡Œ pnpm createå³åˆå§‹åŒ–ï¼Œé’ˆå¯¹å…¬å…±åº“å·¥ç¨‹ï¼Œui åº“å·¥ç¨‹ï¼Œå‰ç«¯ç§å­ä»“åº“éƒ½æœ‰å¯¹åº”çš„æ¨¡ç‰ˆã€‚

nquirer.js æ˜¯ä¸€ä¸ª Node.js åº“ï¼Œå®ƒå¯ä»¥è½»æ¾åœ°åœ¨å‘½ä»¤è¡Œä¸­åˆ›å»ºäº¤äº’å¼é—®é¢˜

Chalk æ˜¯ä¸€ä¸ª Node.js åº“ï¼Œå®ƒå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ç»™æ–‡æœ¬æ·»åŠ é¢œè‰²å’Œæ ¼å¼


```plaintext
/monorepo
â”‚
â”œâ”€â”€ /apps/                   # Frontend and backend applications
â”‚   â”œâ”€â”€ /client/             # Frontend applications
â”‚   â”‚   â”œâ”€â”€ next-app         # A frontend project using Next.js (a React framework with server-side rendering capabilities)
â”‚   â”‚   â”œâ”€â”€ react-app        # A frontend project using React
â”‚   â”‚   â”œâ”€â”€ umi-app          # A frontend project using UmiJS (a React-based framework)
â”‚   â”‚   â”œâ”€â”€ vite-app         # A frontend project using Vite (a frontend build tool)
â”‚   â”‚   â”œâ”€â”€ vite-react-app   # A frontend project using Vite and React
â”‚   â”‚
â”‚   â”œâ”€â”€ /service/            # Backend services
â”‚       â”œâ”€â”€ deno-app         # A backend project using Deno (a modern JavaScript/TypeScript runtime)
â”‚       â”œâ”€â”€ node-app         # A backend project using Node.js
â”‚
â”œâ”€â”€ /shared/                 # Cross-frontend and backend libraries
â”‚   â”œâ”€â”€ /config/             # Shared configuration modules
â”‚   â”‚   â”œâ”€â”€ /src/            # Source code
â”‚   â”‚   â”œâ”€â”€ /tests/          # Test code
â”‚   â”‚   â”œâ”€â”€ package.json     # Project configuration file
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ /utils/              # Shared utility modules
â”‚   â”‚   â”œâ”€â”€ /native/         # Native modules (Rust/C++ compiled to npm for Node.js)
â”‚   â”‚   â”œâ”€â”€ /src/            # Source code
â”‚   â”‚   â”œâ”€â”€ /tests/          # Test code
â”‚   â”‚   â”œâ”€â”€ package.json     # Project configuration file
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ /ui/                 # Component libraries
â”‚   â”‚   â”œâ”€â”€ /react/          # React components
â”‚   â”‚   â”œâ”€â”€ /vue/            # Vue components
â”‚   â”‚   â”œâ”€â”€ src/             # Source code
â”‚   â”‚   â”œâ”€â”€ lib.rs           # Library source (for Rust-based components)
â”‚   â”‚   â”œâ”€â”€ package.json     # Project configuration file
â”‚   â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ /scripts/                # Scripts
â”‚   â”œâ”€â”€ build.js             # Build script
â”‚   â”œâ”€â”€ deploy.js            # Deployment script
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ package.json             # Root-level project configuration file
â”œâ”€â”€ pnpm-workspace.yaml      # PNPM workspace configuration file
â””â”€â”€ .gitignore               # Git ignore file
```


2.3 package.json é…ç½®
ä»¥ä¸‹æ˜¯ä»‹ç» Monorepo ä¸­çš„ package.json é…ç½®ï¼š

```markdown
# Monorepo package.json Configuration

```json
{
    // Package name (example: import {} from 'your-lib')
    "name": "your-lib",
    "version": "1.0.0",
    "description": "A brief description of your package",
    // Files to include in the published package; different from `.npmignore` blacklist, `files` is a whitelist
    "files": ["dist", "es", "lib"],
    // Security measure to prevent accidental publication to npm
    "private": true,
    /**
     * Package dependencies
     */
    // Runtime dependencies, which will be installed by the package consumers
    "dependencies": {
        "lodash": "^4.17.21",
        // âŒ "webpack": "^5.0.0",
        // âŒ "react": "^17.0.0" Not recommended to include React in dependencies
    },
    "peerDependencies": {
       "react": "^16.0.0 || ^17.0.0",
       "react-dom": "^16.0.0 || ^17.0.0"
    },
    // Development dependencies, used only by package developers
    "devDependencies": {
        "rollup": "^2.60.2",
        "eslint": "^8.5.0",
        "react": "^16.0.0",
        "react-dom": "^16.0.0"
    }
}
```

## Dependencies

### dependencies
These are the runtime dependencies that will be installed by the package consumers. Common mistakes include:

- **Incorrect**: Adding build tools or framework dependencies like webpack or React in dependencies, as this can lead to issues such as multiple instances of React in the consumer's project.
  - âŒ `"webpack": "^5.0.0"`: The consumer will install webpack, which is unnecessary unless your module is tightly coupled with webpack functionality.
  - âŒ `"react": "^17.0.0"`: Consumers installing React might face issues with multiple React instances.

### devDependencies
These are development dependencies, used only by the package developers. They are not installed by the consumers.

- **Correct**: Adding build tools, linters, and other development utilities.
  - âœ… `"rollup": "^2.60.2"`
  - âœ… `"webpack": "^5.0.0"`
  - âœ… `"react": "^17.0.0"`

### peerDependencies
These are host dependencies, indicating that the consumer must install these dependencies before using your package. There is some controversy around this setting because, from npm 7 onwards, peer dependencies are automatically installed by default, whereas pnpm and yarn do not.

- **Correct**: Specifying necessary dependencies that should be installed by the consumer to avoid conflicts.
  - âœ… `"react": "^16.0.0 || ^17.0.0"`

### private
If the package should not be published to npm, set this to true to prevent accidental publication, enhancing security.

- **Correct**: Ensuring internal packages or applications within a monorepo are marked as private to avoid unintentional publication.
  - âœ… `"private": true"`


## Monorepo Considerations

ä»“å†…ï¼šé€šè¿‡ pmpn workspace å¯ä»¥æ–¹ä¾¿é“¾æ¥å·¥ä½œåŒºå·¥ç¨‹ï¼Œç›´æ¥ä»ä»£ç å±‚é¢ä¾èµ–ï¼Œè€Œéå¿…éœ€ä½¿ç”¨åŒ…ç®¡ç† / è·¨ä»“åº“çš„ä¾èµ–ã€‚æ— éœ€è¿›è¡Œç‰ˆæœ¬ç®¡ç†


When configuring package.json files in a Monorepo, consider the following additional aspects:

1. **Workspace Configuration**: Use a package manager that supports workspaces (such as Yarn or PNPM) to manage dependencies across multiple projects efficiently.
    - Example for `pnpm-workspace.yaml`:
      ```yaml
      packages:
        - 'apps/*'
        - 'shared/*'
      ```

2. **Shared Dependencies**: Define shared dependencies at the root level of the monorepo to ensure consistency and reduce duplication.
    ```json
    // Root package.json
    {
      "name": "monorepo",
      "private": true,
      "workspaces": [
        "apps/*",
        "shared/*"
      ],
      "dependencies": {
        "react": "^17.0.0",
        "react-dom": "^17.0.0"
      },
      "devDependencies": {
        "eslint": "^8.5.0",
        "prettier": "^2.3.2"
      }
    }
    ```

3. **Scripts**: Define common scripts at the root level to streamline development and CI/CD processes.
    ```json
    // Root package.json
    {
      "scripts": {
        "build": "lerna run build",
        "test": "lerna run test",
        "lint": "eslint '*/**/*.{js,ts,tsx}'"
      }
    }
    ```

By following these guidelines, you can create a well-structured and maintainable Monorepo configuration that leverages shared dependencies and consistent tooling across your projects.


è¿™æ®µå†…å®¹ä¸»è¦è®²çš„æ˜¯å¦‚ä½•åœ¨ `package.json` æ–‡ä»¶ä¸­é…ç½®æ¨¡å—çš„å…¥å£å’Œå¯¼å‡ºï¼Œä»¥é€‚åº”ä¸åŒçš„æ¨¡å—æ ¼å¼å’Œè¿è¡Œç¯å¢ƒï¼ˆå¦‚ CommonJSã€ESMã€æµè§ˆå™¨ç¯å¢ƒç­‰ï¼‰ã€‚å®ƒä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ `main`ã€`module`ã€`browser`ã€`exports` ç­‰å­—æ®µæ¥å£°æ˜æ¨¡å—çš„å…¥å£æ–‡ä»¶ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™äº›é…ç½®æ¥ä¼˜åŒ–åŒ…çš„ä½¿ç”¨ä½“éªŒå’Œæ€§èƒ½ï¼ˆå¦‚æ”¯æŒ Tree Shakingï¼‰ã€‚

### å•å…¥å£é…ç½®

å¯¹äºå•å…¥å£åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š

```json
{
    // -----å•å…¥å£----
    // å…¥å£æ–‡ä»¶ï¼ˆä½¿ç”¨ cjs è§„èŒƒï¼‰
    "main": "lib/index.js",
    // å…¥å£æ–‡ä»¶ï¼ˆä½¿ç”¨ esm è§„èŒƒï¼‰
    "module": "es/index.js",
    // åŒ…ç±»å‹å¯¼å‡º
    "typings": "typings/index.d.ts",
    // æµè§ˆå™¨å…¥å£
    "browser": "dist/index.js",
    "sideEffects": false
}
```

#### å‚æ•°è¯´æ˜ï¼š
- **main**: æŒ‡å®š CommonJS æ ¼å¼çš„å…¥å£æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äº Node.js ç¯å¢ƒã€‚
- **module**: æŒ‡å®š ECMAScript Modules (ESM) æ ¼å¼çš„å…¥å£æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºç°ä»£ JavaScript æ‰“åŒ…å·¥å…·å’Œæµè§ˆå™¨ç¯å¢ƒã€‚
- **browser**: æŒ‡å®šåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨çš„å…¥å£æ–‡ä»¶ï¼Œé€šå¸¸é…ç½®æˆ UMD æ ¼å¼ï¼ˆUniversal Module Definitionï¼‰ã€‚
- **typings**: æŒ‡å®š TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶çš„è·¯å¾„ã€‚
- **sideEffects**: è®¾ç½®ä¸º `false` è¡¨ç¤ºè¯¥åŒ…æ²¡æœ‰å‰¯ä½œç”¨ï¼Œæ‰“åŒ…å·¥å…·å¯ä»¥å®‰å…¨åœ°è¿›è¡Œ Tree Shakingã€‚

### å¤šå…¥å£é…ç½®

å¯¹äºå¤šå…¥å£åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ `exports` å’Œ `browser` å­—æ®µæ¥å®šä¹‰ä¸åŒè·¯å¾„ä¸‹çš„æ¨¡å—å¯¼å‡ºï¼š

```json
{
    // ----å¤šå…¥å£---
    "exports": {
        "./react": {
            "import": "dist/react/index.js",
            "require": "dist/react/index.cjs"
        },
        "./vue": {
            "import": "dist/vue/index.js",
            "require": "dist/vue/index.cjs"
        }
    },
    "browser": {
        "./react": "dist/react/index.js",
        "./vue": "dist/vue/index.js"
    },
    "sideEffects": false
}
```

#### å‚æ•°è¯´æ˜ï¼š
- **exports**: Node.js æå‡ºçš„æ¨¡å—å¯¼å‡ºææ¡ˆï¼Œå…è®¸å®šä¹‰ä¸åŒç¯å¢ƒä¸‹çš„æ¨¡å—è·¯å¾„ã€‚å¯ä»¥ä¸ºæ¯ä¸ªæ¨¡å—è·¯å¾„æŒ‡å®š `import`ï¼ˆESMï¼‰å’Œ `require`ï¼ˆCJSï¼‰æ ¼å¼çš„æ–‡ä»¶ã€‚
  - **import**: æŒ‡å®š ESM æ ¼å¼çš„æ–‡ä»¶è·¯å¾„ï¼Œé€šå¸¸ç”¨äºç°ä»£ JavaScript ç¯å¢ƒã€‚
  - **require**: æŒ‡å®š CJS æ ¼å¼çš„æ–‡ä»¶è·¯å¾„ï¼Œé€šå¸¸ç”¨äº Node.js ç¯å¢ƒã€‚
- **browser**: æŒ‡å®šåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨çš„å…¥å£æ–‡ä»¶è·¯å¾„ã€‚
- **sideEffects**: è®¾ç½®ä¸º `false` è¡¨ç¤ºè¯¥åŒ…æ²¡æœ‰å‰¯ä½œç”¨ï¼Œæ‰“åŒ…å·¥å…·å¯ä»¥å®‰å…¨åœ°è¿›è¡Œ Tree Shakingã€‚

### è¡¥å……å†…å®¹

#### ä½¿ç”¨ `exports` å’Œ `imports` å­—æ®µçš„ä¼˜ç‚¹
- **æ¨¡å—åˆ†å‘ä¼˜åŒ–**ï¼šå¯ä»¥ä¸ºä¸åŒçš„ç¯å¢ƒï¼ˆå¦‚ Node.jsã€æµè§ˆå™¨ï¼‰æä¾›ä¸åŒçš„å…¥å£æ–‡ä»¶ï¼Œæé«˜æ¨¡å—åŠ è½½æ€§èƒ½ã€‚
- **å‡å°‘åŒ…ä½“ç§¯**ï¼šé€šè¿‡é…ç½® `sideEffects: false`ï¼Œå‘ŠçŸ¥æ‰“åŒ…å·¥å…·å¯ä»¥è¿›è¡Œ Tree Shakingï¼Œåˆ é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œå‡å°‘æœ€ç»ˆåŒ…çš„ä½“ç§¯ã€‚
- **æé«˜å…¼å®¹æ€§**ï¼šèƒ½å¤Ÿä¸ºä¸åŒçš„æ¨¡å—ç³»ç»Ÿï¼ˆå¦‚ ESM å’Œ CJSï¼‰æä¾›å…¼å®¹çš„å…¥å£æ–‡ä»¶ï¼Œç¡®ä¿æ¨¡å—åœ¨å„ç§ç¯å¢ƒä¸‹éƒ½èƒ½æ­£å¸¸ä½¿ç”¨ã€‚

#### ç¤ºä¾‹ï¼šé…ç½® TypeScript é¡¹ç›®
å¦‚æœä½ çš„é¡¹ç›®ä½¿ç”¨ TypeScriptï¼Œè¿˜å¯ä»¥æ·»åŠ  TypeScript é…ç½®ï¼Œä»¥ç¡®ä¿ç±»å‹å®šä¹‰æ–‡ä»¶è¢«æ­£ç¡®å¯¼å‡ºå’Œä½¿ç”¨ï¼š

```json
{
    // -----å•å…¥å£----
    "main": "lib/index.js",
    "module": "es/index.js",
    "typings": "dist/index.d.ts",
    "browser": "dist/index.js",
    "sideEffects": false,
    "scripts": {
        "build": "tsc && rollup -c",
        "test": "jest"
    },
    "devDependencies": {
        "typescript": "^4.3.5",
        "rollup": "^2.60.2",
        "jest": "^27.0.6"
    }
}
```


åœ¨è¿™ä¸ªé…ç½®ä¸­ï¼Œ`typings` æŒ‡å‘ç¼–è¯‘åçš„ TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶è·¯å¾„ï¼Œ`scripts` å®šä¹‰äº†æ„å»ºå’Œæµ‹è¯•è„šæœ¬ï¼Œ`devDependencies` åˆ™åŒ…å«äº†å¼€å‘æ‰€éœ€çš„ä¾èµ–ã€‚

é€šè¿‡åˆç†é…ç½® `package.json`ï¼Œå¯ä»¥ç¡®ä¿ä½ çš„æ¨¡å—åœ¨ä¸åŒç¯å¢ƒä¸‹é«˜æ•ˆã€å¯é åœ°è¿è¡Œï¼Œå¹¶ä¸”æ–¹ä¾¿æ¶ˆè´¹è€…ä½¿ç”¨å’Œå¼€å‘è€…ç»´æŠ¤ã€‚

æœ‰äº† package.json é…ç½®ä»¥åŠ æ¨¡å—ç»“æ„ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹æ¨¡å—åŒ…çš„è®¾è®¡

å…±äº«é…ç½®æ¨¡å—ï¼ˆsharedï¼‰
å¦‚æœæˆ‘ä»¬å¸Œæœ›åœ¨æ‰€æœ‰çš„åº”ç”¨ä¸­ä½¿ç”¨è¿™ä¸ªåŒ…ï¼Œåœ¨åº”ç”¨çš„ package.json ä¸­
é¡¹ç›®ä¸­å£°æ˜æ¨¡å—çš„ä¾èµ–ï¼Œworkspace:* è¡¨ç¤ºä½¿ç”¨å½“å‰ Monorepo çš„ shared æ¨¡å—åŒ…


```
// apps/*/package.json
{
  "dependencies": {
     "@infras/shared": "workspace:*"
  }
}
```
åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ import å¼• esm æ ¼å¼ã€require å¼• cjs æ ¼å¼ã€å¸¸ç”¨çš„é¡¹ç›®é…ç½® tsconfig.json
```
// apps/*/index.{ts,tsx,jsx}
import { AppType } from '@infras/shared/types';
import { sum } from '@infras/shared/utils';

console.log(AppType.Web); // 1
console.log(sum(1, 1));   // 2

// apps/*/index.js
const { AppType } = require('@infras/shared/types');
const { sum } = require('@infras/shared/utils');
```
è¿™é‡Œæ˜¯ç¤ºä¾‹å¦‚ä½•å†™ä¸€ä¸ªå…±äº«é…ç½®æ¨¡å—
```
// apps/*/tsconfig.json
{
 "extends": "@infras/shared/configs/tsconfig.base.json"
}
```
ä»¥ä¸‹æ˜¯å¯¹æ„å»º ESM å’Œ CJS æ ¼å¼çš„åŒ…ä»¥åŠç›¸å…³é…ç½®çš„è¯¦ç»†ä»‹ç»ï¼Œå¹¶è¡¥å……äº†ä¸€äº›å†…å®¹ï¼š


## æ„å»º ESM å’Œ CJS æ ¼å¼çš„åŒ…

ä¸ºäº†ç¡®ä¿ä½¿ç”¨æ–¹å¯ä»¥æŒ‰éœ€ä½¿ç”¨ ESM å’Œ CJS æ ¼å¼çš„åŒ…ï¼Œæˆ‘ä»¬éœ€è¦é€‰æ‹©åˆé€‚çš„ç¼–è¯‘å’Œæ‰“åŒ…å·¥å…·ã€‚ä¸‹é¢æ˜¯ç›¸å…³å·¥å…·çš„é€‰æ‹©å’Œé…ç½®è¯´æ˜ã€‚

### æ„å»ºå·¥å…·é€‰æ‹©

#### ç¼–è¯‘å·¥å…·ï¼ˆTransformersï¼‰
- **BabelJS**: ä¸€ä¸ªå¼ºå¤§çš„ JavaScript ç¼–è¯‘å™¨ã€‚
- **TypeScript (tsc)**: TypeScript çš„ç¼–è¯‘å™¨ï¼Œç”¨äºå°† TypeScript è½¬æ¢ä¸º JavaScriptã€‚
- **Esbuild**: ä¸€ä¸ªè¶…å¿«çš„ JavaScript å’Œ TypeScript ç¼–è¯‘å™¨å’Œæ‰“åŒ…å™¨ã€‚

#### æ‰“åŒ…å·¥å…·ï¼ˆBundlersï¼‰
- **Rollup**: ä¸“æ³¨äºæ„å»ºå°è€Œé«˜æ•ˆçš„åŒ…ï¼Œæ”¯æŒ tree-shakingã€‚
- **Esbuild**: é€Ÿåº¦æå¿«çš„ç¼–è¯‘å’Œæ‰“åŒ…å·¥å…·ã€‚
- **Webpack**: åŠŸèƒ½å¼ºå¤§çš„æ‰“åŒ…å·¥å…·ï¼Œé€‚åˆå¤§å‹é¡¹ç›®ã€‚
- **Tsup**: å¼€ç®±å³ç”¨çš„ TypeScript æ„å»ºå·¥å…·ï¼Œæ”¯æŒ ESM å’Œ CJS æ ¼å¼ã€‚
- **Unbuild**: ä¸“æ³¨äºæ„å»ºå’Œå‘å¸ƒ TypeScript åŒ…çš„å·¥å…·ã€‚

### å·¥å…·é€‰æ‹©ç†ç”±

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹© **Tsup** ä½œä¸ºæ„å»ºå·¥å…·ï¼ŒåŸå› å¦‚ä¸‹ï¼š
- **å¿«é€Ÿå’Œæ–¹ä¾¿**: Tsup æä¾›å¼€ç®±å³ç”¨çš„ä½“éªŒï¼Œé…ç½®ç®€å•ã€‚
- **æ”¯æŒå¤šæ ¼å¼è¾“å‡º**: å¯ä»¥åŒæ—¶è¾“å‡º ESM å’Œ CJS æ ¼å¼çš„åŒ…ã€‚
- **ç±»å‹æ”¯æŒ**: Tsup å¯ä»¥ç”Ÿæˆ TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶ã€‚
- **æ€§èƒ½**: ç¼–è¯‘å’Œæ‰“åŒ…é€Ÿåº¦å¿«ã€‚

### Tsup é…ç½®ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ `tsup.config.ts` çš„é…ç½®ç¤ºä¾‹ï¼Œç”¨äºæ„å»º ESM å’Œ CJS æ ¼å¼çš„åŒ…ï¼š

```typescript
// packages/shared/tsup.config.ts
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['utils/index.ts', 'types/index.ts'],
  clean: true,
  dts: true,
  outDir: 'dist',
  format: ['cjs', 'esm']
});
```

æ‰§è¡Œ `tsup` åï¼Œä¼šç”Ÿæˆ `dist` ç›®å½•ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
# packages/shared
- dist
  - utils
    - index.js (CJS)
    - index.mjs (ESM)
  - types
    - index.js (CJS)
    - index.mjs (ESM)
- utils
- types
- package.json
```

**æ³¨**: å°†å¤šå…¥å£ `utils` å’Œ `types` ç›®å½•æ”¾åœ¨ `src` ç›®å½•å¤–æ˜¯ä¸ºäº†åœ¨ Monorepo é¡¹ç›®ä¸­æœ‰æ›´å¥½çš„ TypeScript ç±»å‹æ”¯æŒã€‚å®é™…ä½¿ç”¨æ—¶ï¼Œå°†ç±»å‹æç¤ºæŒ‡å‘æºæ–‡ä»¶ï¼ˆå¦‚ `index.ts`ï¼‰ï¼Œè€ŒçœŸæ­£ä½¿ç”¨çš„æ˜¯ `dist` ç›®å½•ä¸­çš„äº§ç‰©ã€‚

### package.json é…ç½®

å¯¹äºé€šç”¨æ¨¡å—åŒ…çš„ `package.json` é…ç½®å¦‚ä¸‹ï¼Œä½¿ç”¨ `exports` å’Œ `browser` ç»„åˆå¯¼å‡º CJS å’Œ ESM æ ¼å¼çš„åŒ…ï¼š

```json
// packages/shared/package.json
{
  "name": "@infras/shared",
  "version": "0.0.1",
  "description": "An infrastructure monorepo shared library for all projects and apps.",
  "browser": {
    "./types": "./dist/types/index.mjs",
    "./utils": "./dist/utils/index.mjs"
  },
  "exports": {
    "./types": {
      "import": "./dist/types/index.mjs",
      "require": "./dist/types/index.js"
    },
    "./utils": {
      "import": "./dist/utils/index.mjs",
      "require": "./dist/utils/index.js"
    }
  },
  "scripts": {
    "prepare": "npm run build",
    "dev": "tsup --watch",
    "build": "tsup"
  },
  "devDependencies": {
    "tsup": "^5.10.3"
  }
}
```

### å‚æ•°è¯´æ˜

- **main**: æŒ‡å®š CommonJS æ ¼å¼çš„å…¥å£æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äº Node.js ç¯å¢ƒã€‚
- **module**: æŒ‡å®š ECMAScript Modules (ESM) æ ¼å¼çš„å…¥å£æ–‡ä»¶ï¼Œé€šå¸¸ç”¨äºç°ä»£ JavaScript æ‰“åŒ…å·¥å…·å’Œæµè§ˆå™¨ç¯å¢ƒã€‚
- **browser**: æŒ‡å®šåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ä½¿ç”¨çš„å…¥å£æ–‡ä»¶ï¼Œé€šå¸¸é…ç½®æˆ UMD æ ¼å¼ã€‚
- **typings**: æŒ‡å®š TypeScript ç±»å‹å®šä¹‰æ–‡ä»¶çš„è·¯å¾„ã€‚
- **sideEffects**: è®¾ç½®ä¸º `false` è¡¨ç¤ºè¯¥åŒ…æ²¡æœ‰å‰¯ä½œç”¨ï¼Œæ‰“åŒ…å·¥å…·å¯ä»¥å®‰å…¨åœ°è¿›è¡Œ Tree Shakingã€‚
- **exports**: å®šä¹‰æ¨¡å—å¯¼å‡ºçš„è·¯å¾„ï¼Œæ”¯æŒä¸åŒç¯å¢ƒï¼ˆNode.jsã€æµè§ˆå™¨ç­‰ï¼‰ä¸‹ä½¿ç”¨ä¸åŒæ ¼å¼ï¼ˆESMã€CJSï¼‰çš„åŒ…ã€‚
- **scripts**: å®šä¹‰æ„å»ºå’Œå¼€å‘çš„å‘½ä»¤è„šæœ¬ï¼Œæ–¹ä¾¿ä½¿ç”¨ npm æ‰§è¡Œã€‚
- **devDependencies**: å¼€å‘æ—¶ä¾èµ–ï¼Œä½¿ç”¨æ–¹ä¸ä¼šå®‰è£…è¿™äº›ä¾èµ–ï¼Œåªä¸ºåŒ…å¼€å‘è€…æœåŠ¡ã€‚

### `scripts.prepare`

å°† `prepare` æ„å»ºè„šæœ¬åŠ å…¥ `scripts` ä¸­ï¼Œå¯ä»¥ç¡®ä¿åœ¨ä»¥ä¸‹æ—¶æœºæ‰§è¡Œï¼š
- å‘å¸ƒå‰ç¼–è¯‘ï¼ˆç›¸å½“äº `prepublishOnly`ï¼‰ã€‚
- æœ¬åœ° `npm install` æ—¶æ‰§è¡Œï¼ˆä¸åŒäº `postinstall` åœ¨ä»»ä½•æ—¶å€™ `install` éƒ½ä¼šæ‰§è¡Œï¼Œä¼šé€ æˆæ¶ˆè´¹è€…å®‰è£…æ—¶ tsup ä¾èµ–ä¸å­˜åœ¨æŠ¥é”™ï¼‰ã€‚

### ç¤ºä¾‹é…ç½®

```json
{
  "name": "@infras/shared",
  "version": "0.0.1",
  "description": "An infrastructure monorepo shared library for all projects and apps.",
  "main": "lib/index.js",
  "module": "es/index.js",
  "browser": {
    "./types": "./dist/types/index.mjs",
    "./utils": "./dist/utils/index.mjs"
  },
  "exports": {
    "./types": {
      "import": "./dist/types/index.mjs",
      "require": "./dist/types/index.js"
    },
    "./utils": {
      "import": "./dist/utils/index.mjs",
      "require": "./dist/utils/index.js"
    }
  },
  "typings": "dist/index.d.ts",
  "sideEffects": false,
  "scripts": {
    "prepare": "npm run build",
    "dev": "tsup --watch",
    "build": "tsup"
  },
  "devDependencies": {
    "tsup": "^5.10.3"
  }
}
```

é€šè¿‡è¿™ç§æ–¹å¼é…ç½® `package.json` æ–‡ä»¶å’Œæ„å»ºå·¥å…·ï¼Œå¯ä»¥ç¡®ä¿ä½ çš„åŒ…åœ¨ä¸åŒç¯å¢ƒä¸­é«˜æ•ˆã€å¯é åœ°è¿è¡Œï¼Œå¹¶ä¸”æ–¹ä¾¿æ¶ˆè´¹è€…ä½¿ç”¨å’Œå¼€å‘è€…ç»´æŠ¤ã€‚å¦‚æœæœ‰æ›´å¤šçš„å…·ä½“éœ€æ±‚æˆ–é—®é¢˜ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‰©å±•å’Œè‡ªå®šä¹‰è¿™äº›é…ç½®ã€‚

è¿è¡Œï¼š

pnpm start --filter "react-app"

åœ¨ Node.js é¡¹ç›®ä¸­ä½¿ç”¨ pnpm start --filter "node-app"ï¼š
Vite ä¸­ä½¿ç”¨ pnpm start --filter "vite-app" ï¼š


3. CI/CD Process

If each project has several independent pipelines, the overall pipeline will be very large and there will be huge management and maintenance costs. Therefore, centralized management pipeline and standardized Changelog are needed.

#### How to Solve This Issue in a Monorepo

To address the challenges of managing multiple independent pipelines in a monorepo, centralized pipeline management and standardized changelog practices are essential. Here are some recommendations and tools that can help:

1. **Centralized Pipeline Management:**
   - **Nx**: Nx is a smart, fast, and extensible build system with first-class monorepo support and powerful integrations.
   - **Turborepo**: Turborepo is a high-performance build system for JavaScript and TypeScript codebases, designed for monorepos.

2. **Standardized Changelog:**
   - **Conventional Commits**: Adopting the Conventional Commits specification for commit messages can help standardize changelogs and automate the release process.
   - **Semantic Release**: Semantic Release automates the versioning and package publishing process based on the commit history.

#### Recommended Articles and Resources

1. **Nx Documentation**: [Nx Monorepo Documentation](https://nx.dev/getting-started/intro)
2. **Turborepo Documentation**: [Turborepo Documentation](https://turborepo.org/docs)
3. **Conventional Commits**: [Conventional Commits Specification](https://www.conventionalcommits.org/)
4. **Semantic Release**: [Semantic Release Documentation](https://semantic-release.gitbook.io/semantic-release/)
5. **Monorepo CI/CD Best Practices**: [Monorepo CI/CD Best Practices](https://www.martinfowler.com/articles/monorepos.html)

These resources provide comprehensive guidance on setting up and optimizing CI/CD processes in a monorepo environment.

4. **Server-Side Rendering (SSR) Support**

### ç»„ä»¶åº“è®¾è®¡ä¸ä½¿ç”¨

#### ç»„ä»¶åº“æ‰“åŒ…

åœ¨è®¾è®¡å’Œæ‰“åŒ…ç»„ä»¶åº“æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ç»„ä»¶åº“èƒ½å¤Ÿå…¼å®¹å¤šç§ç¯å¢ƒï¼ŒåŒ…æ‹¬æµè§ˆå™¨å’Œ Node.js æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)ã€‚è¿™é‡Œä»¥ `@infras/ui` ä¸ºä¾‹ï¼Œä»‹ç»ç»„ä»¶åº“çš„æ‰“åŒ…å’Œä½¿ç”¨ã€‚

##### æ‰“åŒ…é…ç½®ç¤ºä¾‹

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ `tsup` è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆ ESM å’Œ CJS æ ¼å¼çš„åŒ…ï¼ŒåŒæ—¶ç”Ÿæˆç±»å‹å®šä¹‰æ–‡ä»¶ï¼š

```typescript
// packages/ui/tsup.config.ts
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['react/index.ts', 'vue/index.ts'],
  clean: true,
  dts: true,
  outDir: 'dist',
  format: ['cjs', 'esm'],
  external: ['react', 'vue']
});
```

æ‰§è¡Œ `tsup` åï¼Œä¼šç”Ÿæˆ `dist` ç›®å½•ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
# packages/ui
- dist
  - react
    - index.js (CJS)
    - index.mjs (ESM)
    - index.d.ts (TypeScript)
  - vue
    - index.js (CJS)
    - index.mjs (ESM)
    - index.d.ts (TypeScript)
- react
  - index.ts
- vue
  - index.ts
- package.json
```

##### package.json é…ç½®

ç»„ä»¶åº“çš„ `package.json` é…ç½®å¦‚ä¸‹ï¼š

```json
// packages/ui/package.json
{
  "name": "@infras/ui",
  "version": "0.0.1",
  "description": "A UI component library for React and Vue.",
  "main": "dist/react/index.js",
  "module": "dist/react/index.mjs",
  "exports": {
    "./react": {
      "import": "./dist/react/index.mjs",
      "require": "./dist/react/index.js"
    },
    "./vue": {
      "import": "./dist/vue/index.mjs",
      "require": "./dist/vue/index.js"
    }
  },
  "typings": "dist/index.d.ts",
  "sideEffects": false,
  "scripts": {
    "build": "tsup"
  },
  "devDependencies": {
    "tsup": "^5.10.3"
  },
  "peerDependencies": {
    "react": "^17.0.0 || ^18.0.0",
    "vue": "^3.0.0"
  }
}
```

### ç»„ä»¶åº“åœ¨å‰ç«¯åº”ç”¨ä¸­çš„ä½¿ç”¨

##### é Vite åº”ç”¨é…ç½®

è‹¥ä¸æ˜¯ Vite åº”ç”¨ï¼Œéœ€è¦é…ç½® `dependenciesMeta` ç¡®ä¿æ­£ç¡®å¼•å…¥ç»„ä»¶åº“ï¼š

```json
// apps/*/package.json
{
  "dependencies": {
    "@infras/ui": "workspace:*"
  },
  "dependenciesMeta": {
    "@infras/ui": {
      "injected": true
    }
  }
}
```

##### åœ¨ React å’Œ Vue åº”ç”¨ä¸­å¼•å…¥ç»„ä»¶åº“

- **React åº”ç”¨**ï¼š
  ```typescript
  // apps/react-app/index.tsx
  import { Component } from '@infras/ui/react';

  const App = () => <Component />;
  export default App;
  ```

- **Vue åº”ç”¨**ï¼š
  ```vue
  <!-- apps/vue-app/index.vue -->
  <script setup lang="ts">
  import { Component } from '@infras/ui/vue';
  </script>

  <template>
    <Component />
  </template>
  ```

### ç»„ä»¶åº“æœåŠ¡ç«¯æ¸²æŸ“ (SSR)

ä¸ºäº†åœ¨ Node.js ç¯å¢ƒä¸‹æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ (SSR)ï¼Œéœ€è¦ç¡®ä¿ç»„ä»¶åº“å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå¹¶æ­£ç¡®æ¸²æŸ“ç»„ä»¶ã€‚

- **React SSR**ï¼š
  ```javascript
  // apps/node-app/index.js
  const { Component } = require('@infras/ui/react');
  const React = require('react');
  const ReactDOMServer = require('react-dom/server');

  console.log('SSR: ', ReactDOMServer.renderToString(React.createElement(Component)));
  ```

### æ„å»ºä¸è¿è¡Œåº”ç”¨

- å¯åŠ¨ React åº”ç”¨ï¼š
  ```sh
  pnpm start --filter "react-app"
  ```

- å¯åŠ¨ Vue åº”ç”¨ï¼š
  ```sh
  pnpm start --filter "vite-app"
  ```

### ç»„ä»¶åº“æ‰“åŒ…ä¸ä½¿ç”¨åŸç†

1. **æ‰“åŒ…è¿‡ç¨‹**ï¼š
   - ä½¿ç”¨ `tsup` è¿›è¡Œæ‰“åŒ…ï¼ŒæŒ‡å®šå…¥å£æ–‡ä»¶å’Œè¾“å‡ºæ ¼å¼ï¼ˆESM å’Œ CJSï¼‰ã€‚
   - ç”Ÿæˆçš„æ–‡ä»¶ä¿å­˜åœ¨ `dist` ç›®å½•ä¸­ï¼Œå¹¶ç”Ÿæˆç±»å‹å®šä¹‰æ–‡ä»¶ä»¥ä¾¿åœ¨ TypeScript é¡¹ç›®ä¸­ä½¿ç”¨ã€‚

2. **ä½¿ç”¨è¿‡ç¨‹**ï¼š
   - åœ¨å‰ç«¯åº”ç”¨ä¸­ï¼Œé€šè¿‡é…ç½® `dependencies` å’Œ `dependenciesMeta` å¼•å…¥ç»„ä»¶åº“ã€‚
   - åœ¨ React å’Œ Vue åº”ç”¨ä¸­åˆ†åˆ«å¯¼å…¥ç»„ä»¶åº“ï¼Œå¹¶æŒ‰éœ€ä½¿ç”¨ç»„ä»¶ã€‚

3. **æœåŠ¡ç«¯æ¸²æŸ“**ï¼š
   - ç»„ä»¶åº“éœ€è¦æ”¯æŒåœ¨ Node.js ç¯å¢ƒä¸­è¿è¡Œï¼Œç¡®ä¿å¯ä»¥è¿›è¡ŒæœåŠ¡ç«¯æ¸²æŸ“ã€‚
   - å¯¹äº Reactï¼Œä½¿ç”¨ `react-dom/server` æ¸²æŸ“ç»„ä»¶ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯è¾“å‡ºã€‚

### Vue å’Œ React SSR åŸç†

- **React SSR åŸç†**ï¼š
  - ä½¿ç”¨ `ReactDOMServer.renderToString` æ–¹æ³•å°† React ç»„ä»¶æ¸²æŸ“ä¸º HTML å­—ç¬¦ä¸²ï¼Œç„¶ååœ¨æœåŠ¡å™¨ç«¯è¿”å›è¯¥å­—ç¬¦ä¸²ã€‚
  - è¿™ç§æ–¹å¼å¯ä»¥æé«˜é¦–å±æ¸²æŸ“é€Ÿåº¦ï¼Œå¹¶ä¸”æœ‰åˆ©äº SEOã€‚

- **Vue SSR åŸç†**ï¼š
  - Vue SSR ä½¿ç”¨ `vue-server-renderer` æä¾›çš„æ–¹æ³•å°† Vue ç»„ä»¶æ¸²æŸ“ä¸º HTML å­—ç¬¦ä¸²ã€‚
  - ç±»ä¼¼äº React çš„ `renderToString`ï¼ŒVue çš„ `renderToString` æ–¹æ³•ä¹Ÿå°†ç»„ä»¶æ¸²æŸ“ä¸º HTML å­—ç¬¦ä¸²ï¼Œç„¶ååœ¨æœåŠ¡å™¨ç«¯è¿”å›ã€‚

é€šè¿‡ä»¥ä¸Šé…ç½®å’Œæ–¹æ³•ï¼Œå¯ä»¥åœ¨ Monorepo é¡¹ç›®ä¸­é«˜æ•ˆåœ°æ„å»ºå’Œä½¿ç”¨ç»„ä»¶åº“ï¼Œå¹¶æ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ï¼Œæå‡åº”ç”¨æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒã€‚å¦‚æœæœ‰æ›´å¤šçš„å…·ä½“éœ€æ±‚æˆ–é—®é¢˜ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‰©å±•å’Œè‡ªå®šä¹‰è¿™äº›é…ç½®ã€‚

5. **Adopting Mixed-Language Development (TypeScript/Rust)**

### Adopting Mixed-Language Development (TypeScript/Rust)

åœ¨ Monorepo ä¸­ï¼Œä½¿ç”¨ Rust æˆ– Golang ç¼–å†™çš„ npm æ¨¡å—å¯ä»¥å¸®åŠ©å¤„ç†ä¸€äº› CPU å¯†é›†å‹ä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•åœ¨ Monorepo é¡¹ç›®ä¸­é›†æˆå’Œä½¿ç”¨ Rust æ¨¡å—çš„è¯¦ç»†è¯´æ˜ã€‚

#### ä½¿ç”¨ Rust ç¼–å†™åŸç”Ÿè¯­è¨€æ¨¡å—

##### é¡¹ç›®ç›®å½•ç»“æ„

```
# packages/rs
- src
  - lib.rs
- npm
- index.js
- index.d.ts
- package.json
- Cargo.toml
```

##### åˆå§‹åŒ– Rust æ¨¡å—

ä½¿ç”¨ `napi-rs` åˆå§‹åŒ–ä¸€ä¸ª Rust æ„å»ºçš„ npm æ¨¡å—åŒ…ã€‚`napi-rs` é€‰æ‹©ç”¨ CJS æ ¼å¼æ¥å…¼å®¹ ESMï¼ˆç›¸å…³ node#40541ï¼‰ï¼Œæ— éœ€è¿›è¡Œé¢å¤–ä¿®æ”¹å³å¯ä½¿ç”¨ã€‚

##### package.json é…ç½®

ä»¥ä¸‹æ˜¯ `napi-rs` åˆå§‹åŒ–å‡ºæ¥çš„ `package.json` é…ç½®ï¼š

```json
// packages/rs/package.json
{
  "name": "@infras/rs",
  "version": "0.0.0",
  "type": "commonjs",
  "main": "index.js",
  "types": "index.d.ts",
  "devDependencies": {
    "@napi-rs/cli": "^2.0.0"
  },
  "scripts": {
    "prepare": "npm run build",
    "artifacts": "napi artifacts",
    "build": "napi build --platform --release",
    "build:debug": "napi build --platform",
    "version": "napi version"
  }
}
```

##### Rust ä»£ç ç¤ºä¾‹

åœ¨ `src/lib.rs` ä¸­ç¼–å†™ Rust ä»£ç ï¼Œä¾‹å¦‚ä¸€ä¸ªç®€å•çš„æ±‚å’Œå‡½æ•°ï¼š

```rust
#[macro_use]
extern crate napi_derive;

#[napi]
fn sum(a: i32, b: i32) -> i32 {
    a + b
}
```

##### Node.js åº”ç”¨ä¸­ä½¿ç”¨ Rust æ¨¡å—

åœ¨ Node.js åº”ç”¨ä¸­å£°æ˜åŸç”Ÿè¯­è¨€æ¨¡å—çš„ä¾èµ–ï¼š

```json
// apps/node-app/package.json
{
  "dependencies":{
     "@infras/rs": "workspace:*"
  }
}
```

åœ¨ Node.js åº”ç”¨ä¸­è°ƒç”¨ Rust æ¨¡å—ï¼š

- CommonJS æ¨¡å¼ï¼š

```javascript
// apps/node-app/index.js
const { sum } = require('@infras/rs');
console.log('Rust `sum(1, 1)`:', sum(1, 1)); // 2
```

- ESM æ¨¡å¼ï¼š

```javascript
// apps/node-app/index.mjs
import { sum } from '@infras/rs';
console.log('Rust `sum(1, 1)`:', sum(1, 1)); // 2
```

##### æ„å»ºå’Œè¿è¡Œ

ä½¿ç”¨ `napi-rs` æä¾›çš„å‘½ä»¤æ¥æ„å»º Rust æ¨¡å—ï¼š

```sh
cd packages/rs
pnpm run build
```

æ„å»ºå®Œæˆåï¼Œå¯ä»¥åœ¨ Node.js åº”ç”¨ä¸­è¿è¡Œå¹¶æµ‹è¯•ï¼š

```sh
pnpm start --filter "node-app"
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥çœ‹åˆ° Rust ç¼–è¯‘åçš„å‡½æ•°æ‰§è¡Œæ•ˆç‡æ˜æ˜¾é«˜äº Node.js åŸç”Ÿå‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œä» 8.44ms æå‡è‡³ 0.069msï¼‰ã€‚

### æ€»ç»“

é€šè¿‡åœ¨ Monorepo ä¸­é›†æˆ Rust æ¨¡å—ï¼Œå¯ä»¥æ˜¾è‘—æé«˜å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡çš„æ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯å…³é”®æ­¥éª¤çš„æ€»ç»“ï¼š

1. **åˆå§‹åŒ– Rust æ¨¡å—**ï¼š
   ä½¿ç”¨ `napi-rs` åˆå§‹åŒ–å¹¶é…ç½® `package.json` æ–‡ä»¶ã€‚
   
2. **ç¼–å†™ Rust ä»£ç **ï¼š
   åœ¨ `src/lib.rs` ä¸­ç¼–å†™éœ€è¦çš„åŠŸèƒ½å‡½æ•°ï¼Œå¹¶ä½¿ç”¨ `#[napi]` å®è¿›è¡Œæ ‡æ³¨ã€‚

3. **é…ç½® Node.js åº”ç”¨**ï¼š
   åœ¨ Node.js åº”ç”¨çš„ `package.json` ä¸­å£°æ˜å¯¹ Rust æ¨¡å—çš„ä¾èµ–ï¼Œå¹¶åœ¨ä»£ç ä¸­ä½¿ç”¨ `require` æˆ– `import` å¼•å…¥å¹¶è°ƒç”¨ Rust å‡½æ•°ã€‚

4. **æ„å»ºå’Œè¿è¡Œ**ï¼š
   ä½¿ç”¨ `napi-rs` æä¾›çš„è„šæœ¬æ„å»º Rust æ¨¡å—ï¼Œç„¶ååœ¨ Node.js åº”ç”¨ä¸­è¿è¡Œå¹¶æµ‹è¯•ã€‚

é€šè¿‡è¿™äº›æ­¥éª¤ï¼Œå¯ä»¥åœ¨ Monorepo é¡¹ç›®ä¸­æœ‰æ•ˆåœ°åˆ©ç”¨ Rust çš„é«˜æ€§èƒ½è®¡ç®—èƒ½åŠ›ï¼Œå¤„ç†å¤æ‚å’Œæ€§èƒ½è¦æ±‚é«˜çš„ä»»åŠ¡ã€‚

å¦‚æœæœ‰æ›´å¤šçš„å…·ä½“éœ€æ±‚æˆ–é—®é¢˜ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‰©å±•å’Œè‡ªå®šä¹‰è¿™äº›é…ç½®ã€‚

æ€»ç»“

è¿™å°±æ˜¯æˆ‘ä»¬å¦‚ä½•åœ¨Monorepoä¸­çµæ´»åœ°é›†æˆå’Œç®¡ç†å¤šç§ç±»å‹çš„é¡¹ç›®å’Œæ¨¡å—ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„å¼€å‘å’Œåä½œã€‚

CommonJS åŠ è½½çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆå³module.exportså±æ€§ï¼‰ï¼Œè¯¥å¯¹è±¡åªæœ‰åœ¨è„šæœ¬è¿è¡Œå®Œæ‰ä¼šç”Ÿæˆã€‚

è€Œ ES6 æ¨¡å—ä¸æ˜¯å¯¹è±¡ï¼Œå®ƒçš„å¯¹å¤–æ¥å£åªæ˜¯ä¸€ç§é™æ€å®šä¹‰ï¼Œåœ¨ä»£ç é™æ€è§£æé˜¶æ®µå°±ä¼šç”Ÿæˆã€‚

CommonJSæ¨¡å—çš„åŠ è½½æœºåˆ¶æ˜¯ï¼Œè¾“å…¥çš„æ˜¯è¢«è¾“å‡ºçš„å€¼çš„æ‹·è´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦è¾“å‡ºä¸€ä¸ªå€¼ï¼Œæ¨¡å—å†…éƒ¨çš„å˜åŒ–å°±å½±å“ä¸åˆ°è¿™ä¸ªå€¼ã€‚è¿™ç‚¹ä¸ES6æ¨¡å—åŒ–æœ‰é‡å¤§å·®å¼‚

ESM Firstï¼šæ— è®ºä»€ä¹ˆæ¨¡å—ï¼Œä¼˜å…ˆæ„å»ºå‡º ESM æ ¼å¼ã€‚å¤šå…¥å£åŒ…ä½¿ç”¨ exports ã€browserï¼ˆè‹¥ webpack < 5ï¼‰ï¼Œå•å…¥å£ä½¿ç”¨ mainã€module å¯å¤„ç†å¤§éƒ¨åˆ†æ¨¡å—æ ¼å¼é—®é¢˜



å‚è€ƒæ–‡ç« ï¼š

https://github.com/joelparkerhenderson/monorepo-vs-polyrepo